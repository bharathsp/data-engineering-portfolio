# 🔹 What is Spill-to-Disk in Trino?

By default, **Trino is an in-memory query engine** → it tries to keep all intermediate results in **RAM** for speed.

But sometimes:

* You run a **big join** (fact × fact table joins).
* Or a **heavy aggregation** (GROUP BY with lots of distinct keys).
* Or a **sort** on a huge dataset.

👉 These operations might need **more memory than available per worker**.
Without spill, Trino would fail with an **“EXCEEDED\_MEMORY\_LIMIT”** error.

📌 **Spill-to-disk** = Trino writes (spills) intermediate data to **local SSD/disk** when memory is full → so the query can finish instead of failing.

---

# 🔹 When Does Spill Happen?

Spill is supported for:

1. **Joins** → if hash table doesn’t fit in memory.
2. **Aggregations** → if group-by state grows too large.
3. **Window Functions** → if partitions are too big.
4. **Order By / Sorts** → if sorted data doesn’t fit in memory.

---

# 🔹 How to Enable Spill in Trino

You enable it in the **config.properties** (on workers and coordinators if needed):

```properties
experimental.spill-enabled=true
```

Then, configure specific spill settings:

### 1. Spill Paths (local directories for spill files)

```properties
spiller-spill-path=/data/trino/spill
```

👉 This should be a **fast local disk (NVMe SSD preferred)**, not network storage.

You can set multiple paths (comma-separated) if workers have multiple disks:

```properties
spiller-spill-path=/disk1/trino/spill,/disk2/trino/spill
```

---

### 2. Memory Thresholds

* `query.max-memory` → per query memory limit before spilling starts.
* `query.max-total-memory-per-node` → total memory per node.
* `query.max-spill-per-node` → how much disk can be used for spilling.
* `query.max-spill-per-query` → per-query spill disk limit.

Example:

```properties
query.max-memory=4GB
query.max-total-memory-per-node=16GB
query.max-spill-per-node=100GB
query.max-spill-per-query=20GB
```

---

# 🔹 Monitoring Spill

When a query spills:

* In **Trino Web UI (Query → Stage → Task details)** you’ll see metrics like:

  * *Spilled bytes*
  * *Spill count*

* In logs you may see entries like:

  ```
  INFO  SpillOperator - Spilling 1.2GB to /data/trino/spill/query_20250919...
  ```

---

# 🔹 Pros & Cons of Spill

✅ **Advantages**

* Prevents OOM (out of memory) query failures.
* Lets you run much larger queries without increasing RAM.
* Enables stability for BI and ETL workloads.

⚠️ **Trade-offs**

* **Spill = slower queries** (disk I/O is slower than RAM).
* Requires **enough local disk space** (fast SSD recommended).
* Misconfigured spill → queries may still fail (if disk limits reached).

---

# 🔹 When to Use Spill?

* **Enable** if:

  * You run **large joins/aggregations** and see frequent OOM errors.
  * You have **concurrent users** with big queries.
  * You can provide **fast local SSDs** for spill.

* **Avoid / Limit** if:

  * You already fit workloads in memory comfortably.
  * You’re on **slow disks** (HDDs or network volumes → will cause major slowdowns).

---

✅ **In summary**:

* Spill-to-disk = safety valve to avoid OOM.
* Configure in `config.properties` (`experimental.spill-enabled=true`).
* Tune memory + spill limits carefully.
* Always use **NVMe SSDs** for best performance.
