# 📌 What is Bucketing in Trino?

* 🗂️ **Bucketing** = Dividing data into a fixed number of **buckets (files)** based on a **hash of one or more columns**.
* 📊 Ensures rows with the same key always go to the same bucket.
* ⚡ Useful for **efficient joins** and **sampling**, especially with big data tables.

👉 Think of **Partitioning** as *directory-level split* (by `date`, `region`), while **Bucketing** is a *file-level split* (by hashing `customer_id`, `order_id`).

---

# ⚙️ When to Use Bucketing

* 🔗 To speed up **joins** on large tables (Trino can avoid reshuffling if both sides use the same bucketing key).
* 📊 For **repeatable sampling** (`TABLESAMPLE SYSTEM (10)` works consistently with buckets).
* ⚡ When partitioning would create **too many small files**.

---

# ✅ Example 1: Create a Bucketed Table (Hive Connector in Trino)

```sql
CREATE TABLE hive.retail.customers_bucketed (
    customer_id BIGINT,
    name VARCHAR,
    region VARCHAR
)
WITH (
    format = 'PARQUET',
    bucketed_by = ARRAY['customer_id'],
    bucket_count = 8
);
```

👉 This table is **bucketed into 8 buckets by `customer_id`**.

* Rows with the same `customer_id` → always end up in the same bucket file.

---

# ✅ Example 2: Insert Data

```sql
INSERT INTO hive.retail.customers_bucketed VALUES
(101, 'Alice', 'APAC'),
(102, 'Bob', 'EU'),
(103, 'Charlie', 'US'),
(104, 'David', 'APAC');
```

Trino will hash `customer_id` → distribute into 8 bucket files.

---

# ✅ Example 3: Join Optimization with Buckets

Suppose you have two large bucketed tables on the same key:

```sql
SELECT o.order_id, c.name, o.amount
FROM hive.retail.orders_bucketed o
JOIN hive.retail.customers_bucketed c
  ON o.customer_id = c.customer_id;
```

👉 Since both are bucketed on `customer_id` with the same `bucket_count`,
Trino can **avoid repartitioning/shuffling** → ⚡ faster join.

---

# ✅ Example 4: Sampling with Buckets

```sql
SELECT * 
FROM hive.retail.customers_bucketed
TABLESAMPLE SYSTEM (25);
```

👉 Will consistently sample **25% of buckets**, not random rows → reproducible results.

---

# 🖼️ Partitioning vs Bucketing in Trino

| Feature           | Partitioning 📂                   | Bucketing 🪣                      |
| ----------------- | --------------------------------- | --------------------------------- |
| **Split Method**  | By column values (e.g., `region`) | By hash of column(s) (e.g., `id`) |
| **Storage Level** | Directory-level (coarse)          | File-level (fine)                 |
| **Best For**      | Partition pruning (filtering)     | Joins & repeatable sampling       |
| **Downside**      | Too many partitions = small files | Fixed bucket count, less flexible |

---

# 💡 Pro Tips

* Use **Partitioning** for filtering (like `date`, `region`).
* Use **Bucketing** for **joins** or **sampling consistency**.
* They can be **combined**: partition by `date`, bucket by `customer_id`.
