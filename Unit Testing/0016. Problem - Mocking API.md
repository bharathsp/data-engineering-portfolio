**my\_module.py**

```python
import requests

class APIClient:
    """Simulates an external API client."""

    def get_user_data(self, user_id):
        response = requests.get(f"https://api.example.com/users/{user_id}")
        if response.status_code == 200:
            return response.json()
        raise ValueError("API request failed")


class UserService:
    """Uses APIClient to fetch user data and process it."""

    def __init__(self, api_client):
        # Dependency Injection: pass in APIClient instance
        self.api_client = api_client

    def get_username(self, user_id):
        """Fetches a user and returns their username in uppercase."""
        user_data = self.api_client.get_user_data(user_id)  # Calls API client
        return user_data["name"].upper()  # Processes the result
```

---

**test\_my\_module.py**

```python
import pytest
from my_module import UserService, APIClient

def test_get_username_with_mock(mocker):
    # Create a mock API client
    mock_api_client = mocker.Mock(spec=APIClient)

    # Mock get_user_data to return a fake user
    mock_api_client.get_user_data.return_value = {"id": 1, "name": "Alice"}

    # Inject mock API client into UserService
    service = UserService(mock_api_client)

    # Call method that depends on the mock
    result = service.get_username(1)

    # Assertions
    assert result == "ALICE"  # Check if processing was done correctly
    mock_api_client.get_user_data.assert_called_once_with(1)  # Ensure correct API call
```

---

## **How it works**

### **1. `APIClient`**

* Represents a wrapper for calling an external API.
* Uses `requests.get()` to fetch user data from:

  ```
  https://api.example.com/users/{user_id}
  ```
* Returns JSON if the response is **200 OK**.
* Raises a `ValueError` if the request fails.

---

### **2. `UserService`**

* **Dependency Injection**: Instead of creating an `APIClient` inside the class, it’s passed in from outside.
* **`get_username`**:

  * Calls `api_client.get_user_data(user_id)`.
  * Extracts `"name"` from the result.
  * Returns it **in uppercase**.

---

### **3. The test with `pytest-mock`**

* Uses **`mocker.Mock(spec=APIClient)`**:

  * Creates a mock that behaves like an `APIClient` object.
  * Ensures you can’t call non-existent methods.
* **Mock behavior**:

  ```python
  mock_api_client.get_user_data.return_value = {"id": 1, "name": "Alice"}
  ```

  This simulates what the real API would return.
* **Dependency injection in tests**:

  ```python
  service = UserService(mock_api_client)
  ```

  Instead of a real API call, the service uses the mock.
* **Assertions**:

  * Checks that `"Alice"` becomes `"ALICE"`.
  * Ensures `get_user_data` was called once with argument `1`.

---

✅ **Run it**

```bash
pip install pytest pytest-mock requests
pytest -v
```

Expected output:

```
test_my_module.py::test_get_username_with_mock PASSED
```

---
