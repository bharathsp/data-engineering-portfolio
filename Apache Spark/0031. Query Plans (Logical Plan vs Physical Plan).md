# ⚡ **Apache Spark Query Plans**

When you run a query in Spark (e.g., using DataFrame API or Spark SQL), Spark doesn’t directly execute it. Instead, it goes through a **series of steps**:

1. **Parsing → Logical Plan → Optimized Logical Plan → Physical Plan → Execution**

---

## 🧩 **1. Logical Plan**

* **What it is:**
  A **representation of what the user wants to do**, without worrying about how to do it.
* Created after Spark parses your code (SQL or DataFrame).
* Contains high-level transformations like `select`, `filter`, `join`.

👉 Think of it as a **blueprint** of the query (like an architect’s drawing 🏗️).

* It describes the operations but not the execution details.

**Example:**

```python
df.filter("age > 30").select("name")
```

**Logical Plan:**

```
Project [name]
   Filter (age > 30)
      Relation [name, age, city] parquet
```

---

## 🧩 **2. Optimized Logical Plan**

* Spark applies **Catalyst Optimizer** rules here.
* It simplifies expressions, pushes filters down, prunes unused columns, reorders joins, etc.
* Still **logical**, not tied to execution.

👉 Think of it like the **architect improving the design** for efficiency (e.g., better material, less cost).

---

## 🧩 **3. Physical Plan**

* **What it is:**
  A set of **one or more strategies for execution** on the cluster.
* Spark takes the optimized logical plan and translates it into **RDD operations**.
* Multiple physical plans are possible → Spark chooses the **best one (cost-based)**.

👉 Think of it as the **construction plan 🏗️** (what workers will actually build, step by step).

**Example (Physical Plan output in Spark UI / `explain()`):**

```
*(1) Project [name]
+- *(1) Filter (age > 30)
   +- FileScan parquet [name, age, city] ...
```

Here:

* `*(1)` indicates execution stage.
* `FileScan` shows reading parquet files.
* Filter + Project are applied in sequence.

---

# 🔄 **Analogy: Building a House**

* **Logical Plan** → Architect’s sketch (what you want: 3 rooms, 1 kitchen).
* **Optimized Logical Plan** → Improved design (better layout, fewer walls).
* **Physical Plan** → Construction blueprint (which materials, order of work).
* **Execution** → Workers build the house.

---

# 🖼️ Visual Flow

```
Your Query (SQL/DataFrame)
        ↓
Parser → Unresolved Logical Plan
        ↓
Analyzer → Logical Plan (valid schema, columns)
        ↓
Optimizer → Optimized Logical Plan
        ↓
Planner → Physical Plan(s)
        ↓
Scheduler → Execution (RDD tasks on cluster)
```

---

✅ **In short:**

* **Logical Plan** = What to do (abstract representation).
* **Physical Plan** = How to do it (execution strategy on cluster).
