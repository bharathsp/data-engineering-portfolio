## POS data 
df1 = transaction_id, transaction_date, customer_id, item_id, quantity, sales_value

## Customer data
df2 = customer_id, joining_date

## Identify the top 100 customers who:

1. **Joined within the last 6 months**, and
2. **Have spent at least \$100 on item `999` in the last 6 months**,
   based on the transaction (`df1`) and customer (`df2`) data.

---

### ✅ PySpark Code to Solve This:

Assumptions:

* `df1`: DataFrame with columns: `transaction_id`, `transaction_date`, `customer_id`, `item_id`, `quantity`, `sales_value`
* `df2`: DataFrame with columns: `customer_id`, `joining_date`
* All date columns are in a valid `DateType`
* Today's date is calculated using `current_date()` for the 6-month window

```python
from pyspark.sql.functions import col, current_date, expr, sum as _sum
from pyspark.sql.types import DateType

# Filter customers who joined in the last 6 months
recent_customers = df2.filter(
    col("joining_date") >= expr("add_months(current_date(), -6)")
)

# Filter transactions in the last 6 months and for item_id 999
recent_item999_txns = df1.filter(
    (col("transaction_date") >= expr("add_months(current_date(), -6)")) &
    (col("item_id") == 999)
)

# Join filtered transactions with recent customers
joined_df = recent_item999_txns.join(recent_customers, on="customer_id", how="inner")

# Aggregate sales_value per customer
customer_spend = joined_df.groupBy("customer_id").agg(
    _sum("sales_value").alias("total_spent")
)

# Filter customers who spent at least $100
qualified_customers = customer_spend.filter(col("total_spent") >= 100)

# Get top 100 customers based on total_spent
top_100_customers = qualified_customers.orderBy(col("total_spent").desc()).limit(100)

# Show or collect result
top_100_customers.show()
```

### ✅ SQL Code to Solve This:

```python
SELECT 
    t.customer_id,
    SUM(t.sales_value) AS total_spent
FROM 
    df1 t
JOIN 
    df2 c
    ON t.customer_id = c.customer_id
WHERE 
    c.joining_date >= ADD_MONTHS(CURRENT_DATE, -6)
    AND t.transaction_date >= ADD_MONTHS(CURRENT_DATE, -6)
    AND t.item_id = 999
GROUP BY 
    t.customer_id
HAVING 
    SUM(t.sales_value) >= 100
ORDER BY 
    total_spent DESC
LIMIT 100;
```
